# Task Management API

## Описание

Это тестовый проект для управления задачами с ролевой моделью, реализованный на **Laravel 10** с использованием **PostgreSQL**.  
API покрывает функционал для управления пользователями, проектами, задачами, комментариями и историей изменений с учётом сложной бизнес-логики, производительности, тестируемости и безопасности.

---

## Архитектура и решения

### Стек технологий
- **Laravel 11.x** — фреймворк для реализации API
- **MySQL** — реляционная СУБД
- **Laravel Sanctum** — аутентификация с токенами
- **Laravel Policies** — управление доступами
- **Eloquent ORM** — работа с базой с учётом Eager Loading
- **Laravel Queues** — асинхронная обработка уведомлений при изменении задач
- **Laravel Cache** — кеширование для запросов с фильтрацией
- **Middleware** — кастомный middleware для логирования всех запросов (время выполнения, пользователь, параметры запроса)
- **PHPUnit** — тестирование (Unit + Feature)
- **Mailtrap (sandbox.smtp.mailtrap.io)** — тестовая SMTP для отправки email-уведомлений при изменении задач
- **Pusher + Laravel Echo** — реалтайм нотификации по WebSocket
- **Docker** — контейнеризация для быстрого развёртывания
- **Git** — контроль версий
- **Composer** — менеджер зависимостей PHP

---

### Архитектура
- **Models** — `User`, `Role`, `Project`, `Task`, `Comment`, `TaskHistory`
- **Services** — бизнес-логика (`TaskService`, `CommentService`, `ProjectService`, `TaskHistoryService`)
- **Policies** — контроль доступа (`TaskPolicy`)
- **Scopes** — фильтрация задач по приоритету, статусу, дедлайну, проекту

#### Почему выбран такой подход?
- **Сервисы** — разделяют логику по слоям для поддержки SOLID
- **Политики** — централизованный контроль доступа по ролям
- **Eager Loading + Scopes** — решает проблему N+1 и обеспечивает производительность
- **Очереди + Кэш** — ускоряют обработку запросов при больших объемах данных
- **Mailtrap SMTP** — безопасная песочница для тестовых писем без риска спама

#### Безопасность
- Используются Policies для управления доступами.
- Все запросы к защищённым эндпоинтам проходят через Sanctum.
- SQL-инъекций избегаем за счёт параметризованных запросов в Eloquent. 
- Данные валидируются с помощью Form Requests

#### Для реализации уведомлений при добавлении комментариев используется:
- Pusher — облачный WebSocket-сервис
- Laravel Broadcasting — нативная поддержка событий
- Laravel Echo — JS-клиент для подписки на каналы с фронтенда

---

## API Endpoints

> Авторизация через Sanctum. Все запросы — с заголовком `Authorization: Bearer {token}`.

- **POST** `/api/projects` — создать проект (только `admin` или `manager`)
- **POST** `/api/tasks` — создать задачу с проектом, исполнителями и зависимостями
- **PUT** `/api/tasks/{id}/status` — обновить статус задачи:
    - запрет завершения при незакрытых зависимостях
    - при `blocked` обязательно указать комментарий
- **GET** `/api/tasks` — список задач с фильтрацией по статусу, приоритету, проекту + пагинация
- **GET** `/api/tasks/{id}/history` — история изменений задачи
- **POST** `/api/tasks/{id}/comments` — добавить комментарий к задаче

---

## Установка и запуск

Клонирование репозитория
```bash
git clone https://github.com/malikaarabbay/test_task_board.git
cd test_task_board
```

Скопируйте конфигурацию и настройте доступы к MySQL, Mailtrap и Pusher.
```bash
cp .env.example .env
```

Соберите контейнеры
```bash
docker-compose up -d --build
```

Установите зависимости
```bash
composer install
```

Сгенерируйте ключ:
```bash
php artisan key:generate
```

Выполните миграции с сидами. В проекте подготовлены также сидеры для заполнения базы тестовыми данными для быстрого старта.
```bash
php artisan migrate --seed
```

Установите фронтенд-зависимости и скомпилируйте ресурсы
```bash
npm install
npm run dev
```

Запустите обработчик очередей
```bash
php artisan queue:work
```

(Опционально) Запустите тесты
```bash
php artisan test
```

---

## Postman коллекция

В корне проекта находится готовый файл [TaskManagementAPI.postman_collection.json](./TaskManagementAPI.postman_collection.json), содержащий набор запросов для тестирования всех эндпоинтов API
